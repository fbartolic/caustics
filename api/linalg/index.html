
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Documentation for the caustics package.">
      
      
        <meta name="author" content="Fran Bartolich">
      
      
      <link rel="icon" href="../../_static/logo_docs.svg">
      <meta name="generator" content="mkdocs-1.3.1, mkdocs-material-8.4.2">
    
    
      
        <title>Linear algebra - caustics</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.69437709.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.cbb835fc.min.css">
        
      
      
    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../assets/_mkdocstrings.css">
    
      <link rel="stylesheet" href="../../css/ansi-colours.css">
    
      <link rel="stylesheet" href="../../css/jupyter-cells.css">
    
      <link rel="stylesheet" href="../../css/pandas-dataframe.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="white" data-md-color-accent="amber">
  
    
    
      <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#linear-algebra" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="caustics" class="md-header__button md-logo" aria-label="caustics" data-md-component="logo">
      
  <img src="../../_static/logo_docs.svg" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            caustics
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Linear algebra
            
          </span>
        </div>
      </div>
    </div>
    
      <form class="md-header__option" data-md-component="palette">
        
          
          
          <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="white" data-md-color-accent="amber"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
          
            <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_2" hidden>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m17.75 4.09-2.53 1.94.91 3.06-2.63-1.81-2.63 1.81.91-3.06-2.53-1.94L12.44 4l1.06-3 1.06 3 3.19.09m3.5 6.91-1.64 1.25.59 1.98-1.7-1.17-1.7 1.17.59-1.98L15.75 11l2.06-.05L18.5 9l.69 1.95 2.06.05m-2.28 4.95c.83-.08 1.72 1.1 1.19 1.85-.32.45-.66.87-1.08 1.27C15.17 23 8.84 23 4.94 19.07c-3.91-3.9-3.91-10.24 0-14.14.4-.4.82-.76 1.27-1.08.75-.53 1.93.36 1.85 1.19-.27 2.86.69 5.83 2.89 8.02a9.96 9.96 0 0 0 8.02 2.89m-1.64 2.02a12.08 12.08 0 0 1-7.8-3.47c-2.17-2.19-3.33-5-3.49-7.82-2.81 3.14-2.7 7.96.31 10.98 3.02 3.01 7.84 3.12 10.98.31Z"/></svg>
            </label>
          
        
          
          
          <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="black" data-md-color-accent="amber"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_2">
          
            <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 7a5 5 0 0 1 5 5 5 5 0 0 1-5 5 5 5 0 0 1-5-5 5 5 0 0 1 5-5m0 2a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0-7 2.39 3.42C13.65 5.15 12.84 5 12 5c-.84 0-1.65.15-2.39.42L12 2M3.34 7l4.16-.35A7.2 7.2 0 0 0 5.94 8.5c-.44.74-.69 1.5-.83 2.29L3.34 7m.02 10 1.76-3.77a7.131 7.131 0 0 0 2.38 4.14L3.36 17M20.65 7l-1.77 3.79a7.023 7.023 0 0 0-2.38-4.15l4.15.36m-.01 10-4.14.36c.59-.51 1.12-1.14 1.54-1.86.42-.73.69-1.5.83-2.29L20.64 17M12 22l-2.41-3.44c.74.27 1.55.44 2.41.44.82 0 1.63-.17 2.37-.44L12 22Z"/></svg>
            </label>
          
        
      </form>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/fbartolic/caustics" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.1.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
  </div>
  <div class="md-source__repository">
    fbartolic/caustics
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  

<nav class="md-nav md-nav--primary md-nav--integrated" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="caustics" class="md-nav__button md-logo" aria-label="caustics" data-md-component="logo">
      
  <img src="../../_static/logo_docs.svg" alt="logo">

    </a>
    caustics
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/fbartolic/caustics" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.1.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
  </div>
  <div class="md-source__repository">
    fbartolic/caustics
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        Home
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    
      
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2" type="checkbox" id="__nav_2" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_2">
          Basic API
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Basic API" data-md-level="1">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          Basic API
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../point_source/" class="md-nav__link">
        Point source
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../extended_source/" class="md-nav__link">
        Extended source
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../lightcurve/" class="md-nav__link">
        Lightcurve
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../trajectory/" class="md-nav__link">
        Trajectory
      </a>
    </li>
  

            
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Linear algebra
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Linear algebra
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#caustics.linalg" class="md-nav__link">
    linalg
  </a>
  
    <nav class="md-nav" aria-label="linalg">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#caustics.linalg.marginalized_log_likelihood" class="md-nav__link">
    marginalized_log_likelihood()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                
  <a href="https://github.com/fbartolic/caustics/edit/master/docs/api/linalg.md" title="Edit this page" class="md-content__button md-icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25Z"/></svg>
  </a>



<h1 id="linear-algebra">Linear algebra<a class="headerlink" href="#linear-algebra" title="Permanent link">¤</a></h1>
<p>This module contains a function <code>marginalized_log_likelihood</code> which computes
the log likelihood of a microlensing model marginalized over the linear flux
parameters <span class="arithmatex">\(\beta\equiv(F_s,F_b)^\intercal\)</span>. This function is intended to be 
used a as replacement for the standard likelihood function when optimizing 
the likelihood or doing MCMC.</p>
<p>The marginalization is standard practice when fitting microlensing events 
because it reduces the number of 
parameters in the model by the number of linear parameters in the model. For 
light curves consisting of multiple independent observations (for example, those 
observed by different observatories) this is a necessary step because there 
could be dozens of linear parameters in the model. The way this is traditionally 
done in microlensing is by solving for the linear parameters conditional on 
fixed values of the nonlinear parameters using linear least squares. This 
procedure is justified in some circumstances but it is not valid if the 
data covariance matrix is dense (for example, if we are using a Gaussian Process
to model correlated noise in the light curves or stellar variability of the source 
star). Below, I show how to analytically marginalize over the linear parameters 
in the general case.</p>
<p>The observed flux <span class="arithmatex">\(\mathbf f\)</span> can be written as a linear model 
\begin{equation}
\mathbf f = \mathbf M\,\boldsymbol\beta
\end{equation}
where <span class="arithmatex">\(\mathbf M\)</span> is the design matrix which depends on some nonlinear parameters <span class="arithmatex">\(\boldsymbol\theta\)</span>:</p>
<div class="arithmatex">\[\begin{equation}
    \mathbf{M}\equiv \begin{pmatrix}
        \tilde{A}(t_1;\boldsymbol\theta)     &amp; 1   \\
        \tilde{A}(t_2;\boldsymbol\theta)     &amp; 1  \\
        \vdots                          &amp; \vdots \\
        \tilde{A}(t_{N};\boldsymbol\theta) &amp; 1
    \end{pmatrix}
\end{equation}\]</div>
<p>Assuming that we place a Gaussian prior on the linear parameters <span class="arithmatex">\(\boldsymbol\beta\)</span>
with mean <span class="arithmatex">\(\boldsymbol\mu\)</span> and covariance <span class="arithmatex">\(\boldsymbol\Lambda\)</span>, <a href="https://arxiv.org/abs/2005.14199">one can show</a> 
that the marginal likelihood 
<span class="arithmatex">\(\ln\int p(\mathbf f|\boldsymbol\theta)\,p(\boldsymbol\beta|\boldsymbol\theta)d\boldsymbol\beta\)</span>
is given by</p>
<div class="arithmatex">\[\begin{equation} 
\mathrm{LL}(\boldsymbol\theta)=-\frac{1}{2}\left( \mathbf{f}-\mathbf{M}\boldsymbol{\mu}\right)^\intercal\left(\mathbf{C} + \mathbf{M}\boldsymbol{\Lambda}\mathbf{M}^\intercal\right)^{-1}
\left( \mathbf{f}-\mathbf{M}\boldsymbol{\mu}\right)     
- \frac{1}{2}\ln\left| \mathbf{C} + \mathbf{M}\boldsymbol{\Lambda}\mathbf{M}^\intercal\right|
\end{equation}\]</div>
<p>To compute the inverse and the determinant of the covariance matrix of marginalized likelihood we 
can use the matrix inversion lemma (see Appendix A3 of <a href="https://gaussianprocess.org/gpml/">R&amp;W</a>):</p>
<div class="arithmatex">\[\begin{align}
     &amp; \left(\mathbf{C}+\mathbf{M} \boldsymbol{\Lambda} \mathbf{M}^{\intercal}\right)^{-1}=\mathbf{C}^{-1}-\mathbf{C}^{-1} \mathbf{M}\left(\boldsymbol{\Lambda}^{-1}+\mathbf{M}^{\intercal} \mathbf{C}^{-1} \mathbf{M}\right)^{-1} \mathbf{M}^{\intercal} \mathbf{C}^{-1} \\
     &amp; \ln\left|\mathbf{C}+\mathbf{M} \mathbf{\Lambda} \mathbf{M}^{\intercal}\right|=\ln|\mathbf{C}| +\ln|\boldsymbol{\Lambda}| + \ln\left|\boldsymbol{\Lambda}^{-1}+\mathbf{M}^{\intercal} \mathbf{C}^{-1} \mathbf{M}\right|
\end{align}\]</div>
<p>However, if we marginalize over the linear parameters, how can we obtain their values in order to, for example, produce 
a plot of the model fit? The answer, from the paper linked above, is that the distribution over <span class="arithmatex">\(\boldsymbol\beta\)</span>
conditional on particular values of the nonlinear parameters <span class="arithmatex">\(\boldsymbol\theta\)</span> is a Gaussian 
<span class="arithmatex">\(\mathcal{N}(\boldsymbol\beta;\mathbf a,\mathbf A)\)</span> where</p>
<div class="arithmatex">\[\begin{align}
&amp;\mathbf{A}^{-1}=\boldsymbol\Lambda^{-1}+\mathbf{M}^{\intercal}\mathbf{C}^{-1}\mathbf{M} \\
&amp;\mathbf a = \mathbf A\left(\boldsymbol\Lambda^{-1}\boldsymbol\mu+\mathbf{M}^{\intercal}\mathbf{C}^{-1}\mathbf{f}\right)
\end{align}\]</div>
<p>If we had posterior samples of the nonlinear parameters <span class="arithmatex">\(\boldsymbol\theta\)</span> we could 
could use this distribution to generate samples of the linear parameters.</p>
<p>In <code>marginalized_log_likelihood</code> I use the standard least squares solution for <span class="arithmatex">\(\boldsymbol\beta\)</span> 
if the data covariance matrix is diagonal because it's faster than the matrix 
operations in <span class="arithmatex">\(\mathrm{LL}(boldsymbol\theta)\)</span>. Otherwise I use the full analytic marginalization.</p>


<div class="doc doc-object doc-module">



<h2 id="caustics.linalg" class="doc doc-heading">
          <code>caustics.linalg</code>


<a href="#caustics.linalg" class="headerlink" title="Permanent link">¤</a></h2>

  <div class="doc doc-contents first">

  

  <div class="doc doc-children">









<div class="doc doc-object doc-function">



<h3 id="caustics.linalg.marginalized_log_likelihood" class="doc doc-heading">
<code class="highlight language-python"><span class="n">marginalized_log_likelihood</span><span class="p">(</span><span class="n">A_list</span><span class="p">,</span> <span class="n">fobs_list</span><span class="p">,</span> <span class="n">C_inv_list</span><span class="p">,</span> <span class="n">dense_covariance</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">Lam_sd</span> <span class="o">=</span> <span class="mf">10000.0</span><span class="p">)</span></code>

<a href="#caustics.linalg.marginalized_log_likelihood" class="headerlink" title="Permanent link">¤</a></h3>


  <div class="doc doc-contents ">
  
      <p>Compute the log-likelihood for a microlensing light curve marginalized over
over the linear flux parameters <span class="arithmatex">\(\boldsymbol\beta\equiv(F_s, F_b)^\intercal\)</span>. 
The function takes a list of magnification vectors, a list of observed 
fluxes and a list of inverse data covariance matrices as an input, one element 
of the list represents and independent set of observations, for instance light 
curves from different observatories. The total log-likelihood is then a sum 
of the log-likelihoods for each light curve.</p>
<p>If <code>dense_covariance</code> is False, the inverse data covariance matrices 
are assumed to be 1D vectors containing the elements on the diagonal. In 
that case, the most efficient way to marginalize over the linear parameters 
in the likelihood is to solve the linear least squares problem conditional 
on fixed values of the nonlinear parameters (which determine the 
magnification). If <code>dense_covariance</code> is True, the inverse covariance matrices 
are assumed to be dense matrices. In that case we have to compute the full
marginal likelihood. This increases the computational cost of the likelihood 
evaluation.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>A_list</code></td>
          <td>
                <code>list[array_like]</code>
          </td>
          <td><p>List of 1D magnification arrays, one per 
independent observation.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>fobs_list</code></td>
          <td>
                <code>list[array_like]</code>
          </td>
          <td><p>List of 1D observed flux arrays. </p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>C_inv_list</code></td>
          <td>
                <code>list[array_like]</code>
          </td>
          <td><p>List of nverse data covariance matrices. 
If <code>dense_covariance</code>is False, this is a 1D vector containing the 
diagonal elements of the
covariance matrix. If <code>dense_covariance</code> is True, this is a dense
matrix.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>dense_covariance</code></td>
          <td>
                <code>bool</code>
          </td>
          <td><p>Flag indicating whether <code>C_inv</code> is 
dense or diagonal. Defaults to False.</p></td>
          <td>
                <code>False</code>
          </td>
        </tr>
        <tr>
          <td><code>Lam_sd</code></td>
          <td>
                <code>float</code>
          </td>
          <td><p>Standard deviation of the Gaussian prior on 
the linear flux parameters. The prior is assumed to be a zero mean
independent Gaussian with standard deviation <code>Lam_sd</code> for both linear 
parameters. Defaults to 1e04.</p></td>
          <td>
                <code>10000.0</code>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
<th>Name</th>        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
<td><code>tuple</code></td>          <td>
          </td>
          <td><p>If <code>dense_covariance</code> is False, returns a tuple </p></td>
        </tr>
        <tr>
<td></td>          <td>
          </td>
          <td><p><span class="arithmatex">\((\boldsymbol\beta, \mathrm{LL}(\boldsymbol\theta))\)</span> containing the </p></td>
        </tr>
        <tr>
<td></td>          <td>
          </td>
          <td><p>least-squares solution for the linear parameters and the log-likelihood.</p></td>
        </tr>
        <tr>
<td></td>          <td>
          </td>
          <td><p>Otherwise, the first element of the tuple is 0.</p></td>
        </tr>
    </tbody>
  </table>

  </div>

</div>



  </div>

  </div>

</div>




              
            </article>
            
          </div>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
    
    <nav class="md-footer__inner md-grid" aria-label="Footer" >
      
        
        <a href="../trajectory/" class="md-footer__link md-footer__link--prev" aria-label="Previous: Trajectory" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              Trajectory
            </div>
          </div>
        </a>
      
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.sections", "toc.integrate", "header.autohide"], "search": "../../assets/javascripts/workers/search.ecf98df9.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version.title": "Select version"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.9c69f0bc.min.js"></script>
      
        <script src="../../_static/mathjax.js"></script>
      
        <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
      
    
  </body>
</html>